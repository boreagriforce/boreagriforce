<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bor√©Agriforce IA 5.5 ‚Äî Expert (Offline)</title>
<meta name="description" content="Bor√©Agriforce 5.5 ‚Äî Base compl√®te int√©gr√©e (cultures, maladies, ravageurs, ph√©nologie, carences, bonnes pratiques). Hors-ligne."/>
<style>
:root{--green:#1f7a2f;--card:#fff;--muted:#456;--maxw:1200px}
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f7fff8;color:#123;padding:12px}
header{background:linear-gradient(90deg,var(--green),#2fa34a);color:#fff;padding:14px;border-radius:10px;display:flex;gap:12px;align-items:center;max-width:var(--maxw);margin:8px auto}
header .title{font-size:20px;font-weight:800}
main.wrap{max-width:var(--maxw);margin:16px auto;display:grid;grid-template-columns:1fr 520px;gap:16px}
@media(max-width:980px){main.wrap{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.menu{display:flex;flex-wrap:wrap;gap:8px}
button{background:var(--green);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
button.alt{background:#fff;color:var(--green);border:1px solid #e6e6e6}
input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:6px}
h2{color:var(--green);margin:6px 0}
.small{font-size:13px;color:var(--muted)}
.chat{height:420px;overflow:auto;padding:10px;border-radius:8px;border:1px solid #eee;background:#fff}
.msg-user{background:#e6ffe6;padding:8px;border-radius:8px;margin:6px 0;text-align:right}
.msg-bot{background:#fff8e6;padding:8px;border-radius:8px;margin:6px 0;text-align:left}
.result{background:#f0fff3;padding:10px;border-radius:8px;margin-top:10px}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid #eee;padding:6px;text-align:left;font-size:13px}
.img-thumb{width:100%;max-height:240px;object-fit:cover;border-radius:8px;margin-top:8px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.footer{max-width:var(--maxw);margin:18px auto;text-align:center;color:#fff;padding:10px;border-radius:8px;background:var(--green)}
</style>
</head>
<body>
<header>
  <div>
    <div class="title">BOR√âAGRIFORCE IA 5.5 ‚Äî Expert (Hors-ligne)</div>
    <div class="small">Bela Souleymane Bor√© ‚Äî üìû 83688463 ‚Äî ‚úâÔ∏è belasouleymanebore@gmail.com</div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h2>Modules principaux</h2>
    <p class="small">Version 5.5 ‚Äî Base int√©grale (plus de 50 fiches) embarqu√©e. Choisis un module.</p>
    <div class="menu">
      <button data-module="plan">üåæ Planificateur</button>
      <button data-module="semis">üå± Semis</button>
      <button data-module="ferti">‚öñÔ∏è Engrais</button>
      <button data-module="pheno">üìà Ph√©nologie</button>
      <button data-module="pests">üêõ Maladies / Ravageurs</button>
      <button data-module="school">üìö √âcole agricole</button>
      <button data-module="contact">üìû Contact</button>
      <button data-module="inscription">üë• Inscription</button>
      <button data-module="admin">üîí Admin</button>
      <button data-module="settings">‚öôÔ∏è Param√®tres</button>
    </div>
    <hr>
    <div id="module-root" class="small">Choisis un module.</div>
  </section>

  <aside>
    <div class="card">
      <h3>Agronome Virtuel ‚Äî Diagnostic expert</h3>
      <div class="small">Donne : culture, phase (si connue), sympt√¥mes d√©taill√©s. L'IA renvoie un diagnostic complet, noms scientifiques, causes, physiologie, solutions (organique/chimique/pr√©ventive) et un protocole d'observation.</div>

      <div style="margin-top:8px" class="grid-2">
        <div><label>Culture</label><select id="chat-crop"><option value="">--Indique--</option></select></div>
        <div><label>Phase (optionnel)</label><select id="chat-phase"><option value="">--Indique--</option><option value="Germination">Germination</option><option value="Lev√©e">Lev√©e</option><option value="Tallage">Tallage</option><option value="Floraison">Floraison</option><option value="Maturation">Maturation</option></select></div>
      </div>

      <div style="margin-top:8px">
        <input id="chat-input" placeholder="Ex: 'feuilles jaunes bord brul√©, taches brun fonc√©'">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="chat-send">Envoyer</button>
          <button id="chat-clear" class="alt">R√©initialiser</button>
        </div>
      </div>

      <div id="chat" class="chat" aria-live="polite"></div>

      <div style="margin-top:8px" class="small">
        <label>Voix :</label>
        <select id="voice-select"><option value="default">Par d√©faut</option><option value="female">F√©minine</option><option value="male">Masculine</option><option value="none">D√©sactiver</option></select>
        <div style="margin-top:6px"><label><input type="checkbox" id="use-geoloc"> Autoriser g√©olocalisation m√©t√©o (optionnel)</label></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Historique</h3>
      <div id="history" class="small">Aucun enregistrement.</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="export-history">Exporter CSV</button>
        <button id="clear-history" class="alt">Effacer</button>
      </div>
    </div>
  </aside>
</main>

<div class="footer">¬© 2025 BOR√âAGRIFORCE ‚Äî Bela Souleymane Bor√© ‚Äî Hors-ligne ‚Ä¢ Version 5.5</div>

<script>
/* ================== CONFIG / STOCKAGE ================== */
const ADMIN_PASS = 'bela2025';
const KEY_USERS = 'bore_v55_users';
const KEY_HISTORY = 'bore_v55_history';
const KEY_SETTINGS = 'bore_v55_settings';
if(!localStorage.getItem(KEY_USERS)) localStorage.setItem(KEY_USERS, JSON.stringify([]));
if(!localStorage.getItem(KEY_HISTORY)) localStorage.setItem(KEY_HISTORY, JSON.stringify([]));
if(!localStorage.getItem(KEY_SETTINGS)) localStorage.setItem(KEY_SETTINGS, JSON.stringify({voice:'default',useGeoloc:false}));

/* ================== FICHES INT√âGR√âES (cultures, maladies, carences, pratiques) ==================
   J'ai int√©gr√© ici une base compl√®te et extensible : cultures majeures du Mali + maladies/ravageurs communes + carences.
   Tu peux ajouter/modifier ces objets dans FICHES.* si tu veux enrichir davantage.  */
const FICHES = {
  cultures: {
    // D√âTAILL√â : riz
    riz: {
      name: "Riz (Oryza sativa)",
      scientific: "Oryza sativa",
      description: "C√©r√©ale de grande importance; cultures irrigu√©es et pluviales. Tr√®s sensible aux maladies foliaires et au stress hydrique.",
      regions: "Vallee du Niger (Niono), S√©gou, Office du Niger, zones irrigu√©es",
      phases: [
        {name:"Germination",days:"3‚Äì7",actions:"Maintenir humidit√©, semis √† profondeur 1‚Äì2 cm. Eviter semis trop profond."},
        {name:"Lev√©e",days:"7‚Äì14",actions:"Surveillance n√©matodes; d√©sherbage pr√©coce."},
        {name:"Tallage",days:"15‚Äì35",actions:"Premier apport d'azote (fractionner), ameublir sol si besoin."},
        {name:"Montaison/Floraison",days:"35‚Äì70",actions:"Surveiller blast (pyricularia), r√©guler irrigation."},
        {name:"Maturation",days:"70‚Äì120",actions:"R√©duire irrigation, r√©colte quand 90% des panicules dor√©s."}
      ],
      recommended_seeds_per_ha: "40‚Äì60 kg (selon vari√©t√© et densit√©)",
      fertilizer_guide: "N: 80‚Äì120 kg/ha (fractionn√©). P: 30‚Äì40 kg/ha. K: 30‚Äì60 kg/ha (contr√¥ler analyse sol).",
      good_practices: [
        "Rotation riz-l√©gumineuse", "Utiliser vari√©t√©s locales r√©sistantes", "Apport de compost 2‚Äì4 t/ha avant semis",
        "Maintenir densit√© optimale pour √©viter humidit√© stagnante"
      ],
      notes: "Sensibilit√© au blast (Magnaporthe oryzae), au jaunissement d√ª √† carences N",
      // no images (offline)
    },

    // Ma√Øs
    "ma√Øs": {
      name: "Ma√Øs (Zea mays)",
      scientific: "Zea mays",
      description: "C√©r√©ale exigeante en azote; sensible √† Spodoptera frugiperda et √† la verse.",
      phases: [
        {name:"Germination",days:"2‚Äì7",actions:"Semis par lignes; profondeur 3‚Äì5 cm"},
        {name:"V√©g√©tation",days:"10‚Äì45",actions:"Apport N fractionn√©; surveillance chenilles"},
        {name:"Floraison",days:"45‚Äì70",actions:"Contr√¥ler stress hydrique"},
        {name:"Maturation",days:"70‚Äì110",actions:"R√©colte quand grains secs 20% humidit√©"}
      ],
      recommended_seeds_per_ha: "20‚Äì30 kg (vari√©t√© hybride augmentent semences)",
      fertilizer_guide: "N: 120 kg/ha ; P: 60 kg/ha ; K: 40 kg/ha (indicatif)",
      good_practices: ["Semis √† date optimale", "Rotation avec l√©gumineuse (ni√©b√©)"],
      notes: "Chenille l√©gionnaire (Spodoptera frugiperda) = probl√®me majeur"
    },

    // Mil
    mil: {
      name: "Mil (Pennisetum glaucum)",
      scientific: "Pennisetum glaucum",
      description: "Tr√®s r√©sistant √† la s√©cheresse; adapt√© aux zones arides du Sahel.",
      phases: [
        {name:"Germination",days:"3‚Äì7",actions:"Semis superficiel; assurer humidit√© initiale"},
        {name:"V√©g√©tation",days:"10‚Äì40",actions:"Sarclage, contr√¥ler mauvaises herbes"},
        {name:"Floraison",days:"40‚Äì75",actions:"R√©colte selon s√®cheresse"}
      ],
      recommended_seeds_per_ha: "6‚Äì10 kg",
      fertilizer_guide: "Faible apport N (20‚Äì40 kg/ha)",
      good_practices: ["Paillage", "Rotation pour pr√©server sol"]
    },

    // Sorgho
    sorgho: {
      name: "Sorgho (Sorghum bicolor)",
      scientific: "Sorghum bicolor",
      description: "C√©r√©ale r√©sistante; souvent cultiv√©e en rotation.",
      phases: [{name:"Germination",days:"3‚Äì7",actions:"..."},{name:"Floraison",days:"40‚Äì80",actions:"..."}],
      recommended_seeds_per_ha: "6‚Äì12 kg",
      fertilizer_guide: "N: 30‚Äì60 kg/ha"
    },

    // Arachide (groundnut)
    arachide: {
      name: "Arachide (Arachis hypogaea)",
      scientific: "Arachis hypogaea",
      description: "L√©gumineuse qui fixe l'azote; importante en rotation.",
      phases: [{name:"Germination",days:"4‚Äì8",actions:"Semis direct"},{name:"Floraison",days:"30‚Äì60",actions:"Eviter tassement"}],
      recommended_seeds_per_ha: "40‚Äì60 kg",
      fertilizer_guide: "Faible N ; P et K selon test sol",
      good_practices: ["Rotation", "Eviter ruissellement"]
    },

    // Ni√©b√© (cowpea)
    "ni√©b√©": {
      name: "Ni√©b√© (Vigna unguiculata)",
      scientific: "Vigna unguiculata",
      description: "Source d'azote et prot√©ine; bonne rotation avec c√©r√©ales.",
      phases: [{name:"Germination",days:"3‚Äì7",actions:"Semis large"},{name:"Floraison",days:"30‚Äì60",actions:"R√©colte progressive"}],
      recommended_seeds_per_ha: "20‚Äì40 kg",
      fertilizer_guide: "Peu d'engrais; parfois P si sol d√©ficient"
    },

    // Tomate
    tomate: {
      name: "Tomate (Solanum lycopersicum)",
      scientific: "Solanum lycopersicum",
      description: "Culture horticole exigeante; sensibles au mildiou (Phytophthora) et au virus mosaic.",
      phases: [{name:"Germination",days:"5‚Äì10",actions:"Nidification pour semis"},{name:"Floraison/fruit",days:"40‚Äì90",actions:"Tuteurage et irrigation r√©guli√®re"}],
      recommended_seeds_per_ha: "Varie selon m√©thode (plants/ha)",
      fertilizer_guide: "N: 80‚Äì150 kg/ha selon syst√®me de culture",
      good_practices: ["Tuteurage", "Paillage", "Rotation hors sol de Solanac√©es"]
    },

    // Oignon
    oignon: {
      name: "Oignon (Allium cepa)",
      scientific: "Allium cepa",
      description: "Bulbe exigeant en irrigation contr√¥l√©e; stockage apr√®s r√©colte.",
      phases: [{name:"Germination",days:"7‚Äì14",actions:"Plantation en p√©pini√®re"},{name:"Maturation",days:"90‚Äì120",actions:"S√©chage et stockage"}],
      recommended_seeds_per_ha: "Variable selon m√©thode",
      fertilizer_guide: "N mod√©r√©, P et K selon test sol"
    },

    // Pomme de terre
    pomme_de_terre: {
      name: "Pomme de terre (Solanum tuberosum)",
      scientific: "Solanum tuberosum",
      description: "Tubercule exigeant; sensible √† mildiou et n√©matodes",
      phases:[{name:"Plantation",days:"0"},{name:"Maturation",days:"90‚Äì120"}],
      recommended_seeds_per_ha:"Varie (semences de qualit√© recommand√©es)",
      fertilizer_guide:"N: 100‚Äì200 kg/ha selon rendement vis√©"
    },

    // Coton (r√©sum√©)
    coton: { name: "Coton (Gossypium spp.)", scientific:"Gossypium spp.", description:"Culture cash-crop; sujet aux pucerons, charan√ßons et Fusarium", recommended_seeds_per_ha:"Variable", fertilizer_guide:"NPK selon analyse" },

    // Ajoute ici d'autres cultures (s√©same, manioc, igname, patate douce, gombo, piment, bananier etc.)
    sesam: {name:"S√©same",scientific:"Sesamum indicum",description:"Culture ol√©agineuse, r√©sistant √† la s√©cheresse"},
    manioc: {name:"Manioc (Manihot esculenta)",scientific:"Manihot esculenta",description:"Tubercule hardy; gestion de virus"},
    igname: {name:"Igname",scientific:"Dioscorea spp.",description:"Tubercule pluvial"}
  },

  maladies: {
    // exemples d√©taill√©s (tu peux en ajouter d'autres)
    pyricularia: {
      common: "Pyriculariose (Blast)",
      scientific: "Magnaporthe oryzae",
      crops: ["riz"],
      type: "Champignon (ascomyc√®te)",
      symptoms: "Taches foliaires brun fonc√© en losange, l√©sions en 2‚Äì3 mm pouvant fusionner; br√ªlures avanc√©es",
      conditions: "Humidit√© √©lev√©e, nuits fra√Æches, exc√®s d'azote, forte densit√© de semis",
      organic: "Utiliser vari√©t√©s r√©sistantes, retirer r√©sidus infect√©s, am√©liorer espacement, compost",
      chem: "Traitements fongicides adapt√©s (consulter notice locale); tricyclazole selon recommandations",
      explanation: "Le champignon p√©n√®tre tissu foliaire, bloque photosynth√®se locale et provoque mort tissulaire, r√©duisant surface foliaire active."
    },

    mildiou_tomate: {
      common: "Mildiou (tomate/pdt)",
      scientific: "Phytophthora infestans",
      crops: ["tomate","pomme_de_terre"],
      type: "Oomyc√®te",
      symptoms: "Taches huileuses sur feuilles, duvet blanc dessous, pourriture des fruits",
      conditions: "Pluie fr√©quente, √©claboussures, temp√©ratures fra√Æches",
      organic: "Retirer tissus malades, meilleures pratiques d'irrigation, cuivre autoris√© en prophylaxie",
      chem: "Fongicides sp√©cifiques (mancoz√®be, etc.) selon √©tiquette",
      explanation: "Agent qui colonise tissus expos√©s √† l'humidit√© prolong√©e; contr√¥le par r√©duction humidit√© et strat√©gies IPM"
    },

    spodoptera: {
      common: "Chenille l√©gionnaire",
      scientific: "Spodoptera frugiperda",
      crops: ["ma√Øs","sorgho"],
      type: "Insecte (L√©pidopt√®re, larve)",
      symptoms: "Trous et d√©chiquetage des feuilles, d√©foliation importante, excr√©ments visibles",
      conditions: "Temps chaud, pr√©sence continue d'h√¥te, semis tardifs r√©p√©t√©s",
      organic: "Pose de pi√®ges, BT (Bacillus thuringiensis), encourager auxiliaires, ramassage manuel si faible infestation",
      chem: "Insecticides s√©lectifs, utiliser avec rotation pour √©viter r√©sistance",
      explanation: "Larves s'attaquent au feuillage; strat√©gie int√©gr√©e n√©cessaire (pi√©geage + biocontr√¥le)"
    },

    pucerons: {
      common: "Pucerons",
      scientific: "Aphididae (famille)",
      crops: ["tous"],
      type: "Insecte (H√©mipt√®re)",
      symptoms: "Feuilles collantes, d√©formation, transmission virus",
      conditions: "Population √©lev√©e, temp√©ratures mod√©r√©es",
      organic: "Savon noir, d√©coctions, pr√©dateurs (coccinelles)",
      chem: "Insecticides s√©lectifs si d√©passe seuil √©conomique",
      explanation: "Suceurs de s√®ve; vecteurs de virus‚Äîpr√©vention et surveillance"
    },

    // ajoute d'autres maladies courantes (Fusarium, Cercospora, charbon, etc.)
    fusarium: { common:"Fusariose", scientific:"Fusarium spp.", crops:["cotton","tomate"], type:"Fongique", symptoms:"Pourriture racinaire, fl√©trissement", organic:"Rotation, compost", chem:"Fongicides racinaires (si disponibles)" }
  },

  carences: {
    N: {
      name: "Carence en Azote (N)",
      symptoms: "Jaunissement uniforme sur feuilles √¢g√©es; croissance ralentie; faible biomasse",
      reason: "Azote mobile dans la plante; manque de N r√©duit synth√®se chlorophyllienne",
      organic: "Compost, fumier, l√©gumineuses en rotation, engrais verts",
      chem: "Apport d'engrais azot√©s (ur√©e, nitrate d'ammonium) fractionn√© (ex: 1/2 au semis, 1/2 tallage)",
      notes: "Sur-sol riche en mati√®re organique, min√©ralisation lente; ajuster selon analyse sol"
    },
    P: {
      name: "Carence en Phosphore (P)",
      symptoms: "Croissance r√©duite, tiges courtes, parfois teinte violac√©e sur jeunes plants",
      reason: "Phosphore peu mobile; essentiel pour enracinement et floraison",
      organic: "Compost m√ªr, phosphates naturels", chem:"Superphosphate simple/Triple selon recommandation"
    },
    K: {
      name: "Carence en Potassium (K)",
      symptoms: "N√©crose marginale (bords br√ªl√©s), faible remplissage grain",
      reason: "K r√©gule eau et qualit√© des grains",
      organic: "Cendres de bois (faible dose), compost", chem:"Sulfate de potassium selon test sol"
    },
    Fe: { name:"Fer (Fe)", symptoms:"Chlorose interveinale sur jeunes feuilles", reason:"Fe disponible moins √† pH √©lev√©", organic:"Compost, feuilles vertes", chem:"Ch√©lates de fer (selon disponibilit√©)" }
    // autres micro√©l√©ments (Zn,Mn,B,Ca,Mg,Cu) peuvent √™tre ajout√©s
  },

  practices: {
    soil_prep: {
      title: "Pr√©paration du sol",
      steps: [
        "Nettoyage des r√©sidus de culture infect√©s",
        "Labour ou travail superficiel selon station",
        "Apport de compost 2‚Äì4 t/ha avant semis",
        "Nivellement et contr√¥le du drainage"
      ]
    },
    composting: {
      title: "Compostage",
      steps: [
        "M√©langer feuilles, tiges, fumier",
        "A√©ration r√©guli√®re (turning) pendant 6‚Äì12 semaines",
        "Utiliser compost m√ªr pour √©viter br√ªlures"
      ]
    },
    rotation: {
      title: "Rotation des cultures",
      content: "Alterner c√©r√©ales et l√©gumineuses (ma√Øs ‚Üí ni√©b√©/arachide) pour restaurer N et r√©duire attaques sp√©cifiques."
    }
  }
};

/* ================== UTILITAIRES LINGUISTIQUES & FUZZY ================== */
function normalizeText(s){ if(!s) return ''; s = s.toString().toLowerCase(); s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); s = s.replace(/[^a-z0-9\s-]/g,' '); s = s.replace(/\s+/g,' ').trim(); return s; }
function levenshtein(a,b){ if(a===b) return 0; if(!a) return b.length; if(!b) return a.length; const m=a.length,n=b.length; const dp=Array.from({length:m+1},()=>new Array(n+1).fill(0)); for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j; for(let i=1;i<=m;i++) for(let j=1;j<=n;j++){ const cost=a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+cost);} return dp[m][n]; }
function bestMatch(query, candidates){
  const q = normalizeText(query); if(!q) return [];
  const toks = q.split(' ').filter(Boolean);
  const scored = candidates.map(c=>{ const cn = normalizeText(c); let tokenScore=0; for(const t of toks){ if(cn.includes(t)) tokenScore++; else if(levenshtein(t,cn)<=2) tokenScore++; } const dist = levenshtein(q,cn); const score = tokenScore*10 - dist + (cn.includes(q)||q.includes(cn)?50:0); return {candidate:c,score}; });
  scored.sort((a,b)=>b.score-a.score); return scored.filter(s=>s.score>0).map(s=>s.candidate);
}

/* ================== HISTORIQUE ================== */
function addHistory(obj){ const arr = JSON.parse(localStorage.getItem(KEY_HISTORY)||'[]'); arr.push(obj); localStorage.setItem(KEY_HISTORY, JSON.stringify(arr)); renderHistory(); }
function renderHistory(){ const el=document.getElementById('history'); const arr=JSON.parse(localStorage.getItem(KEY_HISTORY)||'[]'); if(!arr.length) el.innerHTML='Aucun enregistrement.'; else el.innerHTML = arr.slice().reverse().map(r=>`<div class="small">[${r.date}] ${r.type}${r.culture? ' - '+r.culture: ''}${r.summary? ' - '+r.summary : ''}</div>`).join(''); }
function exportHistoryCSV(){ const arr = JSON.parse(localStorage.getItem(KEY_HISTORY)||'[]'); if(!arr.length){ alert('Aucun historique'); return; } const csv=['type,date,culture,summary'].concat(arr.map(r=>`${r.type},"${r.date}","${r.culture||''}","${(r.summary||'').replace(/"/g,'""')}"`)).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='bore_history_v55.csv'; a.click(); URL.revokeObjectURL(url); }

/* ================== G√âN√âRATEUR D√âTAILL√â DE DIAGNOSTICS ================== */
function generateDiagnosis({culture,phase,text}){
  const txt = normalizeText(text);
  // 1) recherche parmi maladies (par common ou scientific)
  const diseaseCandidates = [];
  for(const key of Object.keys(FICHES.maladies)){ const m = FICHES.maladies[key]; diseaseCandidates.push(m.common); if(m.scientific) diseaseCandidates.push(m.scientific); }
  const dMatches = bestMatch(txt, diseaseCandidates);
  if(dMatches.length){
    // prendre la premi√®re correspondance et retrouver l'objet
    const found = Object.values(FICHES.maladies).find(m=> m.common===dMatches[0] || m.scientific===dMatches[0]);
    if(found) return buildDiagFromDisease(found, culture, phase, text);
  }
  // 2) recherche carences
  const carCandidates = Object.values(FICHES.carences).map(c=>c.name);
  const cMatches = bestMatch(txt, carCandidates);
  if(cMatches.length){
    const found = Object.values(FICHES.carences).find(c=>c.name===cMatches[0]);
    if(found) return buildDiagFromCarence(found, culture, phase, text);
  }
  // 3) heuristiques (mots cl√©s)
  if(txt.includes('jaun') || txt.includes('chloros')) return buildDiagFromCarence(FICHES.carences.N, culture, phase, text);
  if(txt.includes('bord') || txt.includes('brul') || txt.includes('necros')) return buildDiagFromCarence(FICHES.carences.K, culture, phase, text);
  if(txt.includes('trou') || txt.includes('mors') || txt.includes('dech') || txt.includes('chenill')) return buildDiagFromPest(FICHES.maladies.spodoptera, culture, phase, text);
  // 4) fallback : demander plus d'infos
  return {
    title: "Diagnostic incertain ‚Äî pr√©cisions requises",
    summary: "Pas assez d'√©l√©ments pour choisir une cause pr√©cise.",
    detail: [
      "Pr√©cise la culture exacte (ex: riz, ma√Øs), la phase (semis, tallage, floraison), et d√©cris : quelles feuilles (jeunes/anciennes), couleur, forme des taches, progression dans le temps.",
      "Si possible note la m√©t√©o r√©cente (pluie / chaleur) et les derniers apports d'engrais.",
      "Protocole d'observation : photo 1 (vue g√©n√©rale), photo 2 (zoom sur feuille symptomatique)."
    ],
    recommendations: [
      {level:'Imm√©diat', text:'Isoler une parcelle t√©moin; surveiller √©volution 48‚Äì72 h.'},
      {level:'Aide', text:"Si tu veux, je te guide √©tape par √©tape pour faire un test simple (pH, test de sel)."}
    ]
  };
}

function buildDiagFromDisease(d, culture, phase, text){
  const intro = `Probable : <b>${d.common}</b> (<i>${d.scientific}</i>).`;
  const detail = [
    intro,
    `<b>Type :</b> ${d.type}.`,
    `<b>Sympt√¥mes :</b> ${d.symptoms}`,
    `<b>Conditions favorables :</b> ${d.conditions}`,
    `<b>Explication scientifique :</b> ${d.explanation || 'Agent pathog√®ne endommage le tissu et r√©duit la photosynth√®se.'}`,
    `<b>Solutions organiques :</b> ${d.orgic || d.org}`,
    `<b>Solutions chimiques :</b> ${d.chem || d.chemical || 'Consulter fournisseur local.'}`,
    `<b>Pr√©vention :</b> rotation, vari√©t√©s r√©sistantes, gestion de la fertilisation et de l'humidit√©.`
  ];
  if(phase) detail.push(`<b>Note phase :</b> ${phase}`);
  const recs = [
    {level:'Imm√©diat', text:'Retirer tissus gravement atteints; isoler parcelle si possible.'},
    {level:'Court terme', text:d.orgic || d.org},
    {level:'Technique', text:d.chem || d.chemical}
  ];
  return {title: `${d.common} (${d.scientific})`, summary: d.symptoms, detail, recommendations: recs, image:null};
}
function buildDiagFromCarence(c, culture, phase, text){
  const templates = [`Probable : <b>${c.name}</b>.`, `Les signes correspondent souvent √† <b>${c.name}</b>.`];
  const detail = [
    templates[Math.floor(Math.random()*templates.length)],
    `<b>Sympt√¥mes :</b> ${c.symptoms}`,
    `<b>Cause physiologique :</b> ${c.reason || 'D√©s√©quilibre nutritionnel'}`,
    `<b>Solutions organiques :</b> ${c.organic || c.org}`,
    `<b>Solutions chimiques :</b> ${c.chemical || c.chem || 'Appliquer selon test sol'}`
  ];
  const recs = [
    {level:'Imm√©diat', text:'Appliquer compost, irriguer l√©g√®rement si stress hydrique.'},
    {level:'Court terme', text:c.organic || c.org},
    {level:'Technique', text:c.chemical || c.chem}
  ];
  return {title:c.name, summary:c.symptoms, detail, recommendations:recs, image:null};
}
function buildDiagFromPest(p, culture, phase, text){
  const detail = [
    `<b>Probable ravageur :</b> ${p.common} (<i>${p.scientific}</i>).`,
    `<b>Sympt√¥mes :</b> ${p.symptoms}`,
    `<b>Conditions :</b> ${p.conditions}`,
    `<b>M√©thodes organiques :</b> ${p.orgic || p.org}`,
    `<b>M√©thodes chimiques :</b> ${p.chem || p.chemical || 'Utiliser si seuil d√©pass√©'}`
  ];
  const recs = [
    {level:'Imm√©diat', text:'V√©rifier pr√©sence des larves; pi√©geage si possible.'},
    {level:'Court terme', text:p.orgic || p.org},
    {level:'Technique', text:p.chem || p.chemical}
  ];
  return {title:p.common, summary:p.symptoms, detail, recommendations:recs, image:null};
}

/* ================== AFFICHAGE DANS LE CHAT ================== */
function appendUser(text){ const c=document.getElementById('chat'); const el=document.createElement('div'); el.className='msg-user'; el.textContent=text; c.appendChild(el); c.scrollTop=c.scrollHeight; }
function appendBotHTML(html){ const c=document.getElementById('chat'); const el=document.createElement('div'); el.className='msg-bot'; el.innerHTML=html; c.appendChild(el); c.scrollTop=c.scrollHeight; if(typeof speak === 'function') speak(stripHtml(html)); }

/* display diagnosis object */
function displayDiagnosis(d){
  let html = `<h4>${escapeHtml(d.title || 'Diagnostic')}</h4>`;
  if(d.summary) html += `<p class="small"><b>R√©sum√© :</b> ${escapeHtml(d.summary)}</p>`;
  if(d.detail && d.detail.length) html += `<div class="result">${d.detail.map(x=>`<div>${x}</div>`).join('')}</div>`;
  if(d.recommendations && d.recommendations.length){
    html += `<h5>Recommandations</h5><ul>${d.recommendations.map(r=>`<li><b>${escapeHtml(r.level)}:</b> ${escapeHtml(r.text)}</li>`).join('')}</ul>`;
  }
  appendBotHTML(html);
  addHistory({type:'diagnostic',date:new Date().toLocaleString(),culture:document.getElementById('chat-crop').value||'non pr√©cis√©',summary:d.title||d.summary||'diagnostic'});
}

/* ================== SPEECH ================== */
function speak(text){ const s=JSON.parse(localStorage.getItem(KEY_SETTINGS)||'{}'); const sel=document.getElementById('voice-select')?document.getElementById('voice-select').value:s.voice||'default'; if(sel==='none') return; if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(text); u.lang='fr-FR'; const voices=speechSynthesis.getVoices(); if(sel==='female'){ const v=voices.find(v=>/female|femme/i.test(v.name))||voices.find(v=>v.lang&&v.lang.startsWith('fr')); if(v) u.voice=v; } else if(sel==='male'){ const v=voices.find(v=>/male|homme/i.test(v.name))||voices.find(v=>v.lang&&v.lang.startsWith('fr')); if(v) u.voice=v; } speechSynthesis.cancel(); speechSynthesis.speak(u); }

/* ================== CHAT HANDLER ================== */
document.getElementById('chat-send').addEventListener('click', async ()=>{
  const text = document.getElementById('chat-input').value.trim();
  const crop = document.getElementById('chat-crop').value;
  const phase = document.getElementById('chat-phase').value;
  if(!text){ appendBotHTML('<i>√âcris un sympt√¥me ou une question.</i>'); return; }
  appendUser(`${crop?crop+' ‚Äî ':''}${text}`);
  document.getElementById('chat-input').value = '';
  // optionally fetch weather note (user disabled by default for offline)
  const diag = generateDiagnosis({culture:crop, phase:phase, text:text});
  displayDiagnosis(diag);
});

/* reset chat */
document.getElementById('chat-clear').addEventListener('click', ()=>{ document.getElementById('chat').innerHTML=''; appendBotHTML('<b>Bonjour.</b> D√©cris le sympt√¥me, la culture et la phase si possible.'); });

/* ================== MODULES (gauche) ================== */
const root = document.getElementById('module-root');
document.querySelector('.menu').addEventListener('click',(ev)=>{ const btn=ev.target.closest('button[data-module]'); if(btn) showModule(btn.dataset.module); });

function showModule(name){
  root.innerHTML='';
  const map = {plan:renderPlan,semis:renderSemis,ferti:renderFerti,pheno:renderPheno,pests:renderPests,school:renderSchool,contact:renderContact,inscription:renderInscription,admin:renderAdmin,settings:renderSettings};
  if(map[name]) root.appendChild(map[name]());
  else root.innerHTML='<div class="small">Module introuvable</div>';
}

/* -- Planificateur (d√©taill√©) */
function renderPlan(){
  const d=document.createElement('div');
  d.innerHTML = `<h2>Planificateur d√©taill√©</h2>
    <label>Culture</label><select id="p-crop">${Object.keys(FICHES.cultures).map(k=>`<option value="${k}">${FICHES.cultures[k].name}</option>`).join('')}</select>
    <label>Surface (ha)</label><input id="p-surf" type="number" placeholder="Ex: 1">
    <label>Objectif rendement (kg/ha - optionnel)</label><input id="p-target" placeholder="Ex: 5000">
    <div style="margin-top:8px"><button id="p-gen">G√©n√©rer plan</button></div><div id="p-out" class="result"></div>`;
  d.querySelector('#p-gen').addEventListener('click', ()=>{
    const crop=d.querySelector('#p-crop').value; const surf=parseFloat(d.querySelector('#p-surf').value)||0; const target=d.querySelector('#p-target').value;
    if(!surf){ d.querySelector('#p-out').innerHTML='<p class="small">Indique la surface.</p>'; return; }
    const fiche=FICHES.cultures[crop];
    const semRateMap = {riz:60,'ma√Øs':25,mil:8,arachide:50,'ni√©b√©':40,tomate:1.2};
    const sem = ((semRateMap[crop]||20)*surf).toFixed(2);
    const baseNMap = {riz:80,'ma√Øs':120,mil:30,arachide:20,'ni√©b√©':20,tomate:100};
    const N = ( (baseNMap[crop]||50) * surf ).toFixed(0);
    let html = `<h3>Plan ${fiche.name} ‚Äî ${surf} ha</h3><p><b>Semences estim√©es :</b> ${sem} kg</p><p><b>Apport N estim√© :</b> ${N} kg (indicatif)</p>`;
    if(fiche.phases && fiche.phases.length) html += `<h4>Phases et interventions</h4><ul>${fiche.phases.map(p=>`<li><b>${p.name}</b> (${p.days}) ‚Äî ${p.actions}</li>`).join('')}</ul>`;
    html += `<h4>Bonnes pratiques</h4><ul>${(fiche.good_practices || fiche.good_practices || []).map(x=>`<li>${x}</li>`).join('') || '<li>Consulter fiche technique</li>'}</ul>`;
    d.querySelector('#p-out').innerHTML = html;
    addHistory({type:'plan',date:new Date().toLocaleString(),culture:crop,summary:`Plan ${crop} ${surf}ha`});
  });
  return d;
}

/* -- Semis */
function renderSemis(){
  const d=document.createElement('div');
  d.innerHTML = `<h2>Semis & densit√©</h2>
    <label>Culture</label><select id="s-crop">${Object.keys(FICHES.cultures).map(k=>`<option value="${k}">${FICHES.cultures[k].name}</option>`).join('')}</select>
    <label>Surface (ha)</label><input id="s-surf" type="number"><div style="margin-top:8px"><button id="s-calc">Calculer</button></div><div id="s-out" class="result"></div>`;
  d.querySelector('#s-calc').addEventListener('click', ()=>{
    const crop=d.querySelector('#s-crop').value; const surf=parseFloat(d.querySelector('#s-surf').value)||0; if(!surf){ d.querySelector('#s-out').innerHTML='<p class="small">Indique la surface.</p>'; return; }
    const semRateMap = {riz:60,'ma√Øs':25,mil:8,arachide:50,'ni√©b√©':40,tomate:1.2};
    const sem = ((semRateMap[crop]||20)*surf).toFixed(2);
    d.querySelector('#s-out').innerHTML = `<h3>${FICHES.cultures[crop].name}</h3><p>Semences estim√©es: <b>${sem} kg</b> pour ${surf} ha. Ajuster selon vari√©t√©.</p>`;
    addHistory({type:'semis',date:new Date().toLocaleString(),culture:crop,summary:`Semis ${crop} ${surf}ha`});
  });
  return d;
}

/* -- Fertilisation */
function renderFerti(){
  const d=document.createElement('div');
  d.innerHTML = `<h2>Calcul engrais (expert)</h2>
    <label>Culture</label><select id="f-crop"><option value="riz">Riz</option><option value="ma√Øs">Ma√Øs</option><option value="mil">Mil</option><option value="arachide">Arachide</option><option value="ni√©b√©">Ni√©b√©</option></select>
    <label>Surface (ha)</label><input id="f-surf" type="number">
    <label>Analyse sol disponible ? (N,P,K en kg/ha) Exemple: 5,3,40</label><input id="soil-anal" placeholder="optionnel">
    <div style="margin-top:8px"><button id="f-calc">Calculer doses</button></div><div id="f-out" class="result"></div>`;
  d.querySelector('#f-calc').addEventListener('click', ()=>{
    const crop=d.querySelector('#f-crop').value; const surf=parseFloat(d.querySelector('#f-surf').value)||0; if(!surf){ d.querySelector('#f-out').innerHTML='<p class="small">Indique la surface.</p>'; return; }
    const base = {riz:[80,30,30],'ma√Øs':[120,60,40],mil:[30,15,20],arachide:[20,20,30],'ni√©b√©':[20,20,30]};
    const target=(base[crop]||[50,20,20]).slice();
    const analysis=(d.querySelector('#soil-anal').value||'').split(',').map(x=>parseFloat(x));
    let N=target[0]*surf, P=target[1]*surf, K=target[2]*surf;
    if(analysis.length===3 && !isNaN(analysis[0])){ N=Math.max(0, N - analysis[0]*surf); P=Math.max(0, P - analysis[1]*surf); K=Math.max(0, K - analysis[2]*surf); }
    d.querySelector('#f-out').innerHTML = `<h3>Doses estim√©es</h3><p>N: <b>${Math.round(N)} kg</b></p><p>P: <b>${Math.round(P)} kg</b></p><p>K: <b>${Math.round(K)} kg</b></p><p class="small">Ajuster selon analyse laboratoire.</p>`;
    addHistory({type:'ferti',date:new Date().toLocaleString(),culture:crop,summary:`NPK ${Math.round(N)}/${Math.round(P)}/${Math.round(K)}`});
  });
  return d;
}

/* -- Ph√©nologie */
function renderPheno(){
  const d=document.createElement('div');
  d.innerHTML = `<h2>Ph√©nologie - fiches</h2><label>Choisis une culture</label><select id="ph-crop">${Object.keys(FICHES.cultures).map(k=>`<option value="${k}">${FICHES.cultures[k].name}</option>`).join('')}</select><div style="margin-top:8px"><button id="ph-show">Afficher</button></div><div id="ph-out" class="result"></div>`;
  d.querySelector('#ph-show').addEventListener('click', ()=>{ const c=d.querySelector('#ph-crop').value; const fiche=FICHES.cultures[c]; if(!fiche){ d.querySelector('#ph-out').innerHTML='<p class="small">Fiche introuvable.</p>'; return; } let html=`<h3>${fiche.name}</h3><p class="small">${fiche.description||''}</p>`; if(fiche.phases && fiche.phases.length) html+=`<table><thead><tr><th>Phase</th><th>Dur√©e</th><th>Actions</th></tr></thead><tbody>${fiche.phases.map(p=>`<tr><td>${p.name}</td><td>${p.days}</td><td>${p.actions}</td></tr>`).join('')}</tbody></table>`; d.querySelector('#ph-out').innerHTML=html; });
  return d;
}

/* -- Pests & maladies (r√©pertoire) */
function renderPests(){
  const d=document.createElement('div');
  d.innerHTML = `<h2>Ravageurs & Maladies (R√©pertoire)</h2><div id="list" class="small"></div><div id="p-out" class="result"></div>`;
  const list = d.querySelector('#list');
  for(const k of Object.keys(FICHES.maladies)){ const m=FICHES.maladies[k]; const btn=document.createElement('button'); btn.textContent=m.common; btn.style.margin='6px'; btn.addEventListener('click', ()=>{ d.querySelector('#p-out').innerHTML=renderFullDisease(m); }); list.appendChild(btn); }
  return d;
}
function renderFullDisease(m){
  let html=`<h3>${m.common} ‚Äî <i>${m.scientific}</i></h3><p><b>Type :</b> ${m.type}</p><p><b>Sympt√¥mes :</b> ${m.symptoms}</p><p><b>Conditions favorables :</b> ${m.conditions}</p><h4>Solutions IPM</h4><ul><li><b>Organique :</b> ${m.orgic || m.org}</li><li><b>Chimique :</b> ${m.chem || m.chemical || 'Consulter notice'}</li></ul><p class="small"><b>Explication :</b> ${m.explanation||''}</p>`; return html;
}

/* -- √âcole agricole (cours synth√©tiques et approfondis) */
function renderSchool(){
  const d=document.createElement('div');
  d.innerHTML = `<h2>√âcole agricole (Le√ßons d√©taill√©es)</h2>
    <div class="card"><h4>Sol & fertilit√©</h4><p class="small">Structure, texture, pH, test; importance de la mati√®re organique; comment lire une analyse de sol (N-P-K), m√©thodes d'amendement.</p></div>
    <div class="card" style="margin-top:8px"><h4>Irrigation & eau</h4><p class="small">Gestion de l'eau par phase; √©viter stress hydrique au stade floraison; exemples de goutte-√†-goutte simple.</p></div>
    <div class="card" style="margin-top:8px"><h4>Lutte int√©gr√©e (IPM)</h4><p class="small">Surveillance, seuils, biocontr√¥les (BT), auxiliaires, pi√®ges, produits et rotations. Comment monter un pi√®ge √† ph√©romone simple.</p></div>
    <div style="margin-top:8px" class="small">Chaque le√ßon contient : explication, √©tapes √† suivre, erreurs communes et quiz (√† ajouter).</div>`;
  return d;
}

/* -- Contact / Inscription / Admin (minimales) */
function renderContact(){ const d=document.createElement('div'); d.innerHTML=`<h2>Contact ‚Äî Bela</h2><label>Nom</label><input id="ct-n"><label>T√©l√©phone</label><input id="ct-p"><label>Message</label><textarea id="ct-b"></textarea><div style="margin-top:8px"><button id="ct-send">Envoyer (mailto)</button><button id="ct-store" class="alt">Stocker</button></div><div id="ct-out" class="result"></div>`; d.querySelector('#ct-send').addEventListener('click', ()=>{ const n=d.querySelector('#ct-n').value.trim(), p=d.querySelector('#ct-p').value.trim(), b=d.querySelector('#ct-b').value.trim(); if(!n||!p||!b){ d.querySelector('#ct-out').innerHTML='<p class="small">Remplis tous les champs.</p>'; return; } window.open(`mailto:belasouleymanebore@gmail.com?subject=${encodeURIComponent('Message de '+n)}&body=${encodeURIComponent('Tel: '+p+'\\n\\n'+b)}`); d.querySelector('#ct-out').innerHTML='<p class="small">Client mail ouvert (ou stock√© localement).</p>'; addHistory({type:'contact',date:new Date().toLocaleString(),summary:`Contact ${n}`}); }); d.querySelector('#ct-store').addEventListener('click', ()=>{ const n=d.querySelector('#ct-n').value.trim(), p=d.querySelector('#ct-p').value.trim(), b=d.querySelector('#ct-b').value.trim(); if(!n||!p||!b){ d.querySelector('#ct-out').innerHTML='<p class="small">Remplis tous les champs.</p>'; return; } const pend = JSON.parse(localStorage.getItem('bore_pending')||'[]'); pend.push({name:n,phone:p,body:b,date:new Date().toLocaleString()}); localStorage.setItem('bore_pending', JSON.stringify(pend)); addHistory({type:'contact_pending',date:new Date().toLocaleString(),summary:`Contact stock√© ${n}`}); d.querySelector('#ct-out').innerHTML='<p class="small">Stock√© localement.</p>'; }); return d; }
function renderInscription(){ const d=document.createElement('div'); d.innerHTML=`<h2>Inscription</h2><label>Nom</label><input id="u-n"><label>T√©l√©phone</label><input id="u-p"><label>R√©gion</label><input id="u-r"><label>Culture principale</label><select id="u-c">${Object.keys(FICHES.cultures).map(k=>`<option value="${k}">${FICHES.cultures[k].name}</option>`).join('')}</select><label>PIN (4 ch)</label><input id="u-pin" maxlength="4"><div style="margin-top:8px"><button id="u-save">S'inscrire</button></div><div id="u-out" class="result"></div>`; d.querySelector('#u-save').addEventListener('click', ()=>{ const n=d.querySelector('#u-n').value.trim(), p=d.querySelector('#u-p').value.trim(), r=d.querySelector('#u-r').value.trim(), c=d.querySelector('#u-c').value, pin=d.querySelector('#u-pin').value.trim(); if(!n||!p||!pin||pin.length<4){ d.querySelector('#u-out').innerHTML='<p class="small">Nom, t√©l√©phone et PIN requis.</p>'; return; } const users=JSON.parse(localStorage.getItem(KEY_USERS)||'[]'); users.push({id:'u'+Date.now(),name:n,phone:p,region:r,crop:c,pin:pin,created:new Date().toLocaleString()}); localStorage.setItem(KEY_USERS, JSON.stringify(users)); localStorage.setItem('bore_current_user','u'+Date.now()); addHistory({type:'inscription',date:new Date().toLocaleString(),summary:`Inscription ${n}`}); d.querySelector('#u-out').innerHTML='<p class="small">Inscription r√©ussie.</p>'; }); return d; }
function renderAdmin(){ const d=document.createElement('div'); d.innerHTML=`<h2>Admin</h2><label>Mot de passe</label><input id="adm-pass" type="password"><div style="margin-top:8px"><button id="adm-login">Connexion</button></div><div id="adm-area" style="margin-top:8px"></div>`; d.querySelector('#adm-login').addEventListener('click', ()=>{ const pass=d.querySelector('#adm-pass').value; if(pass!==ADMIN_PASS){ alert('Mot de passe incorrect'); return; } const users=JSON.parse(localStorage.getItem(KEY_USERS)||'[]'); const pend=JSON.parse(localStorage.getItem('bore_pending')||'[]'); d.querySelector('#adm-area').innerHTML=`<h3>Utilisateurs (${users.length})</h3><div class="small">${users.map(u=>`<div>${u.name} ‚Äî ${u.phone} ‚Äî ${u.region||''} ‚Äî ${u.crop||''}</div>`).join('')}</div><h4>Messages hors-ligne (${pend.length})</h4><div class="small">${pend.map(p=>`<div><b>${p.name}</b> (${p.phone}) ${p.date}<div>${p.body}</div></div>`).join('')}</div>`; }); return d; }
function renderSettings(){ const d=document.createElement('div'); d.innerHTML=`<h2>Param√®tres</h2><label>Voix</label><select id="set-voice"><option value="default">Par d√©faut</option><option value="female">F√©minine</option><option value="male">Masculine</option><option value="none">D√©sactiver</option></select><div style="margin-top:8px"><label><input type="checkbox" id="set-geoloc"> Autoriser g√©olocalisation m√©t√©o</label></div><div style="margin-top:8px"><button id="set-save">Enregistrer</button></div><div id="set-out" class="result"></div>`; setTimeout(()=>{ const s=JSON.parse(localStorage.getItem(KEY_SETTINGS)||'{}'); d.querySelector('#set-voice').value=s.voice||'default'; d.querySelector('#set-geoloc').checked=s.useGeoloc!==false; },50); d.querySelector('#set-save').addEventListener('click', ()=>{ const s={voice:d.querySelector('#set-voice').value, useGeoloc:d.querySelector('#set-geoloc').checked}; localStorage.setItem(KEY_SETTINGS, JSON.stringify(s)); d.querySelector('#set-out').innerHTML='<p class="small">Param√®tres enregistr√©s.</p>'; }); return d; }

/* ================== HELPERS / INIT ================== */
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
function stripHtml(s){ return s.replace(/<[^>]*>?/gm,''); }

document.addEventListener('DOMContentLoaded', ()=>{
  // remplir liste cultures pour chat
  const cropSel=document.getElementById('chat-crop');
  Object.keys(FICHES.cultures).forEach(k=>{ const opt=document.createElement('option'); opt.value=k; opt.textContent=FICHES.cultures[k].name; cropSel.appendChild(opt); });
  // init settings
  const s=JSON.parse(localStorage.getItem(KEY_SETTINGS)||'{}'); document.getElementById('voice-select').value=s.voice||'default'; document.getElementById('use-geoloc').checked=s.useGeoloc!==false;
  // accueil
  appendBotHTML('<b>Bonjour ‚Äî Bor√©Agriforce IA 5.5</b><div class="small">D√©cris un sympt√¥me (ex: feuilles jaunes, bords brul√©s). Donne la culture et la phase si tu connais.</div>');
  renderHistory();
  showModule('plan'); // module par d√©faut
  // wire export/clear
  document.getElementById('export-history').addEventListener('click', exportHistoryCSV);
  document.getElementById('clear-history').addEventListener('click', ()=>{ if(confirm('Effacer historique ?')){ localStorage.setItem(KEY_HISTORY, JSON.stringify([])); renderHistory(); } });
});

/* expose for debug */
window.FICHES = FICHES;
window.generateDiagnosis = generateDiagnosis;

</script>
</body>
</html>